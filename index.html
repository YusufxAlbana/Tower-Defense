<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Epic Tower Defense - Commander Edition">
    <title>Tower Defense: Commander Edition</title>
    
    <!-- EXTERNAL LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- STYLES -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap');
        
        * {
            user-select: none;
            -webkit-user-drag: none;
        }

        body {
            font-family: 'Rajdhani', 'Segoe UI', Tahoma, sans-serif;
            touch-action: none;
            background-color: #0f172a;
            overflow: hidden;
        }
        
        .pixel-font {
            font-family: 'Press Start 2P', cursive;
        }
        
        .tech-font {
            font-family: 'Rajdhani', sans-serif;
        }

        canvas {
            image-rendering: pixelated;
            cursor: crosshair;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Animations */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(234, 179, 8, 0.5); border-color: rgba(234, 179, 8, 0.6); }
            50% { box-shadow: 0 0 15px rgba(234, 179, 8, 0.8); border-color: rgba(234, 179, 8, 1); }
        }
        .animate-glow { animation: pulse-glow 2s infinite; }

        .scanline {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.05) 50%, rgba(0,0,0,0.05));
            background-size: 100% 4px; pointer-events: none; z-index: 9999; opacity: 0.3;
        }

        .tower-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .tower-btn:active { transform: scale(0.95); }
        
        .glass-panel {
            background: rgba(31, 41, 55, 0.85); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .screen { transition: opacity 0.3s ease-in-out; }
        .screen.hidden { opacity: 0; pointer-events: none; display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        #loginScreen { overflow-y: auto; }

        /* Stat Bar Animation */
        @keyframes fillBar { from { width: 0; } to { width: 100%; } }
        .stat-fill { animation: fillBar 1s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-950 text-white h-screen overflow-hidden relative selection:bg-yellow-500 selection:text-black">

    <div class="scanline"></div>

    <!-- NAVBAR -->
    <nav id="mainNavbar" class="hidden absolute top-0 w-full bg-gray-900/95 backdrop-blur-md border-b-2 border-gray-700 p-3 flex justify-between items-center z-50 shadow-2xl transition-transform duration-300 ease-in-out">
        <div class="flex items-center gap-4 md:gap-8">
            <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition-opacity" onclick="window.gameSystem.ui.showScreen('home')">
                <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-lg border-2 border-white/20 shadow-inner flex items-center justify-center transform rotate-3 hover:rotate-0 transition-transform">
                    <i class="fa-solid fa-shield-halved text-black text-lg"></i>
                </div>
                <div class="flex flex-col">
                    <h1 class="hidden md:block text-yellow-400 pixel-font text-xs tracking-[0.2em] leading-tight text-shadow">FORTRESS</h1>
                    <span class="hidden md:block text-[9px] text-gray-400 tracking-widest tech-font font-bold">DEFENSE SYSTEM</span>
                </div>
            </div>
            
            <div class="flex gap-2 bg-gray-800/50 p-1 rounded-lg border border-gray-700">
                <button onclick="window.gameSystem.ui.showScreen('home')" id="navBtnHome" class="relative px-4 py-1.5 rounded-md font-bold text-xs md:text-sm hover:bg-gray-700 transition text-white border-b-2 border-transparent hover:border-yellow-500"><i class="fa-solid fa-house mr-2"></i>BASE</button>
                <button onclick="window.gameSystem.ui.showScreen('deck')" id="navBtnDeck" class="relative px-4 py-1.5 rounded-md font-bold text-xs md:text-sm hover:bg-gray-700 transition text-gray-400 border-b-2 border-transparent hover:border-green-500"><i class="fa-solid fa-layer-group mr-2"></i>DECK</button>
                <button onclick="window.gameSystem.ui.showScreen('shop')" id="navBtnShop" class="relative px-4 py-1.5 rounded-md font-bold text-xs md:text-sm hover:bg-gray-700 transition text-gray-400 border-b-2 border-transparent hover:border-blue-500"><i class="fa-solid fa-cart-shopping mr-2"></i>SHOP</button>
            </div>
        </div>

        <div class="flex items-center gap-4 md:gap-6">
            <div class="flex items-center gap-3 bg-gray-800 px-4 py-1.5 rounded-full border border-gray-600 shadow-inner group cursor-help" title="Shop Coins">
                <div class="w-5 h-5 bg-yellow-400 rounded-full border-2 border-yellow-200 shadow-[0_0_10px_orange] group-hover:animate-bounce flex items-center justify-center text-black text-[10px] font-bold">C</div>
                <span id="navCoinDisplay" class="font-mono text-yellow-400 font-bold text-sm tracking-wider">...</span>
            </div>
            <div class="flex items-center gap-3 pl-4 border-l border-gray-700">
                <div class="text-right hidden sm:block">
                    <p class="text-[8px] text-gray-500 uppercase tracking-widest font-bold">STATUS: ONLINE</p>
                    <p id="navUsername" class="text-white font-bold text-sm leading-none tracking-wide truncate max-w-[120px] text-blue-300">Commander</p>
                </div>
                <button onclick="window.gameSystem.auth.logout()" class="group bg-red-600/10 hover:bg-red-600 text-red-400 hover:text-white p-2 rounded-lg border border-red-500/30 transition-all duration-200" title="Logout">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- 0. LOGIN SCREEN -->
    <div id="loginScreen" class="screen absolute inset-0 z-[60] bg-gray-950 flex flex-col items-center justify-center p-4 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsPSJub25lIiBzdHJva2U9IiMxNzI1NTQiIHN0cm9rZS13aWR0aD0iMC41Ij48cGF0aCBkPSJNMCAwaDQwdjQwSDBaIi8+PC9zdmc+')] overflow-y-auto">
        <div class="w-full max-w-sm flex flex-col items-center my-auto py-10">
            <div class="mb-8 text-center transform hover:scale-105 transition duration-700 cursor-default">
                <div class="w-20 h-20 mx-auto bg-gradient-to-b from-yellow-400 to-yellow-600 rounded-2xl mb-4 shadow-[0_0_30px_rgba(234,179,8,0.3)] flex items-center justify-center border-4 border-white/20">
                    <i class="fa-solid fa-shield-halved text-4xl text-black"></i>
                </div>
                <h1 class="text-4xl md:text-5xl text-yellow-400 pixel-font mb-2 leading-tight drop-shadow-lg tracking-tighter">
                    FORTRESS<br><span class="text-white text-2xl md:text-3xl">DEFENSE</span>
                </h1>
                <div class="h-1 w-24 bg-yellow-500 mx-auto rounded-full mt-2 shadow-[0_0_10px_yellow]"></div>
            </div>
            
            <div class="glass-panel p-6 rounded-2xl border border-gray-700 shadow-2xl w-full relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
                <h2 class="text-lg font-bold text-white mb-6 text-center tracking-[0.2em] tech-font relative z-10">COMMANDER ACCESS</h2>
                <div class="space-y-4 relative z-10">
                    <div class="group/input">
                        <label class="block text-[10px] text-gray-400 uppercase tracking-widest mb-1 font-bold ml-1">Codename</label>
                        <input type="text" id="usernameInput" class="w-full bg-gray-900/50 border border-gray-600 rounded-lg p-2.5 text-white focus:border-blue-500 focus:outline-none" placeholder="e.g., AlphaOne">
                    </div>
                    <div class="group/input">
                        <label class="block text-[10px] text-gray-400 uppercase tracking-widest mb-1 font-bold ml-1">Passcode</label>
                        <input type="password" id="passwordInput" class="w-full bg-gray-900/50 border border-gray-600 rounded-lg p-2.5 text-white focus:border-blue-500 focus:outline-none" placeholder="******">
                    </div>
                    <p id="authMessage" class="text-red-400 text-xs min-h-[1.5rem] text-center font-mono animate-pulse pt-2"></p>
                    <div class="flex gap-3 mt-4">
                        <button id="btnLogin" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg transition">LOGIN</button>
                        <button id="btnRegister" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg transition">REGISTER</button>
                    </div>
                </div>
            </div>
            <p class="mt-6 text-gray-500 text-[10px] font-mono opacity-60">Defense System V4.5 // Powered by Firebase</p>
        </div>
    </div>

    <!-- 1. HOME SCREEN -->
    <div id="homeScreen" class="screen hidden absolute inset-0 z-40 bg-gray-900 pt-16 flex flex-col items-center justify-center space-y-8 p-4 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-gray-800 via-gray-950 to-black overflow-y-auto">
        <div class="text-center space-y-6 animate-fade-in max-w-2xl mt-auto mb-auto">
            <div class="inline-block p-2 border border-yellow-500/30 rounded-full bg-yellow-500/10 backdrop-blur mb-2">
                <span class="text-yellow-500 text-[10px] font-bold tracking-[0.3em] px-4 flex items-center gap-2">
                    <span class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></span>
                    SYSTEM ONLINE
                </span>
            </div>
            <h1 class="text-5xl md:text-8xl text-white pixel-font leading-tight tracking-widest drop-shadow-2xl">
                MAIN<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">BASE</span>
            </h1>
            <p class="text-gray-400 text-lg md:text-xl tracking-[0.2em] uppercase font-light border-t border-b border-gray-800 py-4">
                "Defense is the best offense"
            </p>
        </div>
        
        <div class="flex flex-col gap-4 w-full max-w-sm pb-10">
            <button onclick="window.gameSystem.ui.showScreen('mapSelect')" class="group relative px-8 py-6 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-xl shadow-[0_0_20px_rgba(37,99,235,0.5)] active:scale-95 transition-all w-full overflow-hidden border-2 border-blue-400">
                <span class="relative z-10 flex items-center justify-center gap-3 pixel-font">
                    START MISSION
                    <i class="fa-solid fa-play"></i>
                </span>
                <div class="absolute top-0 -inset-full h-full w-1/2 z-5 block transform -skew-x-12 bg-gradient-to-r from-transparent to-white opacity-20 group-hover:animate-shine"></div>
            </button>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="window.gameSystem.ui.showScreen('deck')" class="px-6 py-4 bg-gray-800 hover:bg-gray-700 text-white font-bold rounded-xl text-sm shadow-lg active:scale-95 transition-all flex flex-col items-center justify-center gap-2 border border-gray-700 hover:border-green-500 group">
                    <i class="fa-solid fa-layer-group text-2xl text-green-400 group-hover:scale-110 transition-transform"></i>
                    MANAGE DECK
                </button>
                <button onclick="window.gameSystem.ui.showScreen('shop')" class="px-6 py-4 bg-gray-800 hover:bg-gray-700 text-white font-bold rounded-xl text-sm shadow-lg active:scale-95 transition-all flex flex-col items-center justify-center gap-2 border border-gray-700 hover:border-blue-500 group">
                    <i class="fa-solid fa-cart-shopping text-2xl text-blue-400 group-hover:scale-110 transition-transform"></i>
                    ARMORY
                </button>
            </div>
        </div>
    </div>

    <!-- 2. SHOP SCREEN -->
    <div id="shopScreen" class="screen hidden absolute inset-0 z-40 bg-gray-900 pt-24 px-4 pb-4 overflow-y-auto scroll-smooth">
        <div class="max-w-7xl mx-auto pb-20">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-5xl text-white pixel-font mb-4 tracking-wide text-shadow">ARMORY</h2>
                <div class="h-1 w-24 bg-blue-500 mx-auto rounded-full mb-4"></div>
                <p class="text-gray-400 max-w-md mx-auto">Acquire latest technology to defend your base against the swarm.</p>
            </div>
            <!-- UPGRADES -->
            <div class="mb-16 animate-fade-in-up">
                <h3 class="text-yellow-400 font-bold mb-6 border-b border-gray-700 pb-2 flex items-center gap-3 text-xl tracking-widest">BASE UPGRADES</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 hover:border-yellow-500 transition-all duration-300 relative group hover:shadow-[0_0_20px_rgba(234,179,8,0.2)]">
                        <div class="absolute top-4 right-4"><span class="bg-gray-900 text-yellow-500 text-[10px] font-bold px-2 py-1 rounded border border-yellow-500/30">PASSIVE</span></div>
                        <div class="flex items-start gap-5 mb-6">
                            <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-green-700 rounded-2xl flex items-center justify-center text-4xl shadow-lg text-white"><i class="fa-solid fa-money-bill-wave"></i></div>
                            <div>
                                <h3 class="font-bold text-white text-xl font-mono">STARTING FUNDS</h3>
                                <p class="text-xs text-green-400 font-mono mt-1 bg-green-900/30 inline-block px-2 py-0.5 rounded">Level: <span id="lvl-startMoney" class="text-white">0</span></p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-400 mb-6 leading-relaxed min-h-[40px]">Increases mission starting cash by <span class="text-white font-bold">+50</span>.</p>
                        <div class="flex justify-between items-center border-t border-gray-700 pt-4 mt-auto">
                            <div class="text-yellow-400 font-mono font-bold text-lg flex items-center gap-2"><span>ðŸŸ¡</span><span id="price-startMoney">2000</span></div>
                            <button onclick="window.gameSystem.shop.buyUpgrade('startMoney', 2000)" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold text-sm shadow-lg active:scale-95 transition-all">BUY</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- TURRETS -->
            <div class="animate-fade-in-up" style="animation-delay: 0.1s;">
                <h3 class="text-blue-400 font-bold mb-6 border-b border-gray-700 pb-2 flex items-center gap-3 text-xl tracking-widest">TURRET LICENSES</h3>
                <div id="shopTurretContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            </div>
        </div>
    </div>

    <!-- SHOP DETAILS MODAL (NEW) -->
    <div id="shopDetailsModal" class="hidden fixed inset-0 z-[60] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-gray-800 w-full max-w-md rounded-2xl border-2 border-gray-600 shadow-2xl relative overflow-hidden animate-fade-in">
            <!-- Background Decoration -->
            <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-bl from-blue-500/20 to-transparent rounded-bl-full pointer-events-none"></div>
            
            <!-- Header -->
            <div class="p-6 pb-2 flex justify-between items-start">
                <div class="flex items-center gap-4">
                    <div id="modalIcon" class="w-16 h-16 rounded-xl bg-gray-700 flex items-center justify-center text-3xl border-2 border-white/20 shadow-lg"></div>
                    <div>
                        <h2 id="modalTitle" class="text-2xl font-bold text-white tracking-wide font-mono">UNKNOWN</h2>
                        <span id="modalType" class="text-xs font-bold px-2 py-0.5 rounded bg-gray-700 text-gray-300 uppercase tracking-wider">TYPE</span>
                    </div>
                </div>
                <button onclick="window.gameSystem.shop.closeDetails()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>

            <!-- Stats Body -->
            <div class="p-6 space-y-5">
                <!-- Damage Stat -->
                <div>
                    <div class="flex justify-between text-xs text-gray-400 mb-1 font-bold">
                        <span>DAMAGE</span>
                        <span class="font-mono text-white"><span id="statDmgCurr">0</span> <span class="text-green-400 text-[10px]">(+<span id="statDmgUp">0</span>)</span></span>
                    </div>
                    <div class="h-2 bg-gray-900 rounded-full overflow-hidden flex">
                        <div id="barDmgBase" class="h-full bg-red-500"></div>
                        <div id="barDmgUp" class="h-full bg-green-500 animate-pulse"></div>
                    </div>
                </div>

                <!-- Range Stat -->
                <div>
                    <div class="flex justify-between text-xs text-gray-400 mb-1 font-bold">
                        <span>RANGE</span>
                        <span class="font-mono text-white"><span id="statRngCurr">0</span> <span class="text-green-400 text-[10px]">(+<span id="statRngUp">0</span>)</span></span>
                    </div>
                    <div class="h-2 bg-gray-900 rounded-full overflow-hidden flex">
                        <div id="barRngBase" class="h-full bg-blue-500"></div>
                        <div id="barRngUp" class="h-full bg-green-500 animate-pulse"></div>
                    </div>
                </div>

                <!-- Fire Rate Stat -->
                <div>
                    <div class="flex justify-between text-xs text-gray-400 mb-1 font-bold">
                        <span>FIRE RATE</span>
                        <span class="font-mono text-white"><span id="statSpdCurr">0</span>/s <span class="text-green-400 text-[10px]">(+<span id="statSpdUp">0</span>)</span></span>
                    </div>
                    <div class="h-2 bg-gray-900 rounded-full overflow-hidden flex">
                        <div id="barSpdBase" class="h-full bg-yellow-500"></div>
                        <div id="barSpdUp" class="h-full bg-green-500 animate-pulse"></div>
                    </div>
                </div>
            </div>

            <!-- Footer Info -->
            <div class="p-4 bg-gray-900/50 border-t border-gray-700/50 flex justify-between items-center">
                <div class="text-xs text-gray-500 max-w-[60%] leading-tight">
                    Stats showing <span class="text-green-400">Level 2 Upgrade</span> potential.
                </div>
                <div id="modalCostContainer" class="text-right">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- 3. DECK SCREEN -->
    <div id="deckScreen" class="screen hidden absolute inset-0 z-40 bg-gray-900 pt-24 px-4 pb-4 overflow-y-auto flex flex-col items-center">
        <div class="w-full max-w-6xl animate-fade-in">
            <div class="text-center mb-10">
                <h2 class="text-3xl md:text-5xl text-white pixel-font mb-3 text-shadow">LOGISTICS</h2>
                <p class="text-gray-400 text-sm font-mono bg-gray-800 inline-block px-4 py-1 rounded-full border border-gray-700">Deployment Capacity: Max 5 Units. Min 1.</p>
            </div>
            <!-- Active Deck -->
            <div class="bg-gray-800/80 p-8 rounded-3xl border border-gray-700 mb-10 shadow-2xl backdrop-blur-sm">
                <div class="flex justify-between items-center mb-8 pb-4 border-b border-gray-700/50">
                    <h3 class="text-green-400 font-bold tracking-[0.2em] text-lg flex items-center gap-3"><span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>ACTIVE DECK (<span id="deckCount" class="text-white">0</span>/5)</h3>
                    <span class="text-xs text-gray-400 italic bg-black/30 px-3 py-1 rounded-lg border border-gray-700">Click to remove</span>
                </div>
                <div id="activeDeckContainer" class="flex flex-wrap justify-center gap-6 min-h-[140px] items-center bg-black/20 rounded-2xl p-6 border-2 border-dashed border-gray-700/50">
                    <span class="text-gray-500 italic font-mono">Deck is empty. Select units below.</span>
                </div>
            </div>
            <!-- Collection -->
            <div class="bg-gray-800/80 p-8 rounded-3xl border border-gray-700 shadow-2xl backdrop-blur-sm">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-blue-400 font-bold tracking-[0.2em] text-lg">STORAGE</h3>
                    <div class="text-xs text-blue-300/70 font-mono">Available Inventory</div>
                </div>
                <div id="collectionContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
            </div>
        </div>
    </div>

    <!-- 4. MAP SELECTION -->
    <div id="mapSelectScreen" class="screen hidden absolute inset-0 z-50 bg-gray-900/95 flex flex-col items-center justify-center p-4 backdrop-blur-lg pt-20 overflow-y-auto">
        <h2 class="text-3xl md:text-5xl font-bold text-white mb-12 pixel-font text-center drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]">CONFLICT ZONES</h2>
        <div id="mapListContainer" class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-7xl px-4 pb-20"></div>
        <div class="fixed bottom-8 left-1/2 transform -translate-x-1/2">
            <button onclick="window.gameSystem.ui.showScreen('home')" class="text-gray-400 hover:text-white hover:scale-105 transition-all text-sm flex items-center gap-2 bg-gray-800/90 px-6 py-3 rounded-full border border-gray-700 hover:border-white shadow-lg backdrop-blur">ABORT MISSION</button>
        </div>
    </div>

    <!-- 5. GAME SCREEN -->
    <div id="gameUI" class="screen hidden h-screen flex flex-col items-center justify-center w-full relative bg-black">
        <!-- UI Header -->
        <div class="w-full max-w-6xl p-3 flex justify-between items-center bg-gray-900/90 rounded-b-2xl shadow-2xl border-b border-gray-700 z-10 shrink-0 backdrop-blur mx-4 mt-0 relative">
            <button onclick="window.gameSystem.game.quit()" class="mr-4 text-gray-400 hover:text-red-400 p-2 rounded-lg hover:bg-gray-800 transition border border-transparent hover:border-gray-700" title="Abort Mission">
                <i class="fa-solid fa-right-from-bracket text-xl"></i>
            </button>
            <div class="flex gap-6 md:gap-12 flex-grow justify-center">
                <div class="flex flex-col items-center"><span class="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-1">INTEGRITY</span><div class="flex items-center gap-2"><i class="fa-solid fa-heart text-red-500"></i><span id="livesDisplay" class="text-2xl font-mono font-bold text-white drop-shadow-md">20</span></div></div>
                <div class="flex flex-col items-center px-8 border-x border-gray-800"><span class="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-1">FUNDS</span><div class="flex items-center gap-2"><span class="text-yellow-400 text-xl">$</span><span id="moneyDisplay" class="text-2xl font-mono font-bold text-yellow-400 drop-shadow-md">200</span></div></div>
                <div class="flex flex-col items-center"><span class="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-1">WAVE</span><span id="waveDisplay" class="text-2xl font-mono font-bold text-blue-400 drop-shadow-md">1</span></div>
            </div>
            <div class="flex gap-3">
                <button onclick="window.gameSystem.game.surrender()" class="bg-red-900/50 hover:bg-red-600 text-red-300 hover:text-white font-bold py-2 px-4 rounded-lg transition flex items-center gap-2 border border-red-800 hover:border-red-500 group" title="Surrender">
                    <i class="fa-solid fa-flag"></i>
                </button>
                <button id="startWaveBtn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg text-sm shadow-[0_0_15px_rgba(22,163,74,0.6)] active:scale-95 transition-all border border-green-400 flex items-center gap-2 animate-pulse"><span class="w-2 h-2 bg-white rounded-full animate-ping"></span>START</button>
            </div>
        </div>

        <div class="relative mt-4 shadow-2xl rounded-xl overflow-hidden border-4 border-gray-800 bg-black shrink-0 relative ring-1 ring-gray-700">
            <canvas id="gameCanvas" width="800" height="600" class="max-w-full h-auto max-h-[65vh] md:max-h-[70vh] block"></canvas>
            
            <!-- Upgrade Menu -->
            <div id="upgradeMenu" class="hidden absolute bottom-4 right-4 bg-gray-900/95 border border-yellow-500/50 rounded-xl p-5 w-72 shadow-2xl backdrop-blur-md z-20 animate-fade-in">
                <div class="flex justify-between items-start mb-4 border-b border-gray-700 pb-2">
                    <div><h3 id="upgName" class="font-bold text-yellow-400 text-lg tracking-wide font-mono">TOWER</h3><p class="text-xs text-gray-400 font-mono">LVL <span id="upgLevel" class="text-white font-bold">1</span></p></div>
                    <button onclick="window.gameSystem.ui.closeUpgradeMenu()" class="text-gray-500 hover:text-white bg-gray-800 hover:bg-red-900 rounded-lg w-8 h-8 flex items-center justify-center transition">&times;</button>
                </div>
                <div class="space-y-3 text-sm text-gray-300 mb-6 font-mono">
                    <div class="flex justify-between items-center bg-black/40 px-3 py-1.5 rounded"><span>DMG</span><span id="upgDamage" class="text-white font-bold">20</span></div>
                    <div class="flex justify-between items-center bg-black/40 px-3 py-1.5 rounded"><span>RNG</span><span id="upgRange" class="text-white font-bold">120</span></div>
                    <div class="flex justify-between items-center bg-black/40 px-3 py-1.5 rounded"><span>SPD</span><span id="upgSpeed" class="text-white font-bold">40</span></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button id="btnUpgradeAction" onclick="window.gameSystem.game.upgradeSelected()" class="bg-green-700 hover:bg-green-600 text-white py-3 rounded-lg text-xs font-bold shadow-lg transition-all flex flex-col items-center justify-center border border-green-500/50 group">
                        <span class="mb-1 group-hover:scale-110 transition-transform">UPGRADE</span><span id="upgCost" class="text-[10px] text-green-200 bg-black/30 px-2 rounded-full">$ 100</span>
                    </button>
                    <button onclick="window.gameSystem.game.sellSelected()" class="bg-red-900 hover:bg-red-800 text-white py-3 rounded-lg text-xs font-bold shadow-lg transition-all flex flex-col items-center justify-center border border-red-500/50 group">
                        <span class="mb-1 group-hover:scale-110 transition-transform">SELL</span><span id="sellValue" class="text-[10px] text-red-200 bg-black/30 px-2 rounded-full">$ 50</span>
                    </button>
                </div>
            </div>

            <!-- Game Over -->
            <div id="gameOverScreen" class="hidden absolute inset-0 bg-gray-950/90 backdrop-blur-sm flex flex-col items-center justify-center z-50 p-4">
                <div class="transform scale-100 transition-all duration-500 animate-fade-in">
                    <h2 id="gameOverTitle" class="text-5xl md:text-7xl font-bold text-red-600 mb-2 pixel-font text-center leading-tight tracking-wider drop-shadow-[0_5px_5px_rgba(0,0,0,1)]">GAME OVER</h2>
                    <p id="gameOverSubtitle" class="text-xl text-gray-400 mb-10 tracking-[0.5em] uppercase text-center font-mono">Mission Failed</p>
                    <div class="bg-gray-900 p-8 rounded-2xl border-2 border-gray-700 mb-10 w-full max-w-md shadow-2xl relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
                        <h3 class="text-white font-bold mb-6 text-center border-b border-gray-800 pb-4 tracking-wide text-lg tech-font">MISSION REPORT</h3>
                        <div class="space-y-4 font-mono">
                            <div class="flex justify-between items-center"><span class="text-gray-500 text-sm font-bold uppercase">Wave Reached</span><span class="text-white font-bold text-2xl" id="statWave">1</span></div>
                            <div class="flex justify-between items-center"><span class="text-gray-500 text-sm font-bold uppercase">Hostiles Eliminated</span><span class="text-green-400 font-bold text-2xl" id="statKilled">0</span></div>
                            <div class="flex justify-between items-center bg-yellow-900/20 p-4 rounded-xl border border-yellow-700/30 mt-4">
                                <span class="text-yellow-500 font-bold text-sm uppercase tracking-wide">COINS EARNED</span>
                                <div class="flex items-center gap-3"><div class="w-4 h-4 bg-yellow-500 rounded-full shadow-[0_0_10px_yellow]"></div><span class="text-yellow-400 font-bold text-2xl" id="statCoinsEarned">+0</span></div>
                            </div>
                            <div class="text-center pt-4 mt-4 border-t border-gray-800"><span class="text-gray-600 text-xs uppercase tracking-widest">Total Treasury</span><div class="text-white font-bold text-lg mt-1" id="statTotalCoins">...</div></div>
                        </div>
                    </div>
                    <div class="flex gap-4 justify-center">
                        <button onclick="window.gameSystem.game.quit()" class="bg-gray-800 text-gray-300 font-bold py-4 px-8 rounded-xl hover:bg-gray-700 transition border border-gray-600 hover:text-white hover:border-white">RETURN</button>
                        <button onclick="window.gameSystem.game.restart()" class="bg-white text-black font-bold py-4 px-10 rounded-xl hover:bg-gray-200 transition shadow-[0_0_20px_rgba(255,255,255,0.3)] hover:scale-105 transform">RETRY MISSION</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="gameTowerSelection" class="w-full max-w-5xl mt-4 p-4 bg-gray-800/90 backdrop-blur rounded-t-3xl border-t-2 border-gray-700 flex justify-center gap-4 overflow-x-auto shrink-0 pb-6 shadow-[0_-10px_40px_rgba(0,0,0,0.8)] min-h-[100px] items-center"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBrSTR6OyNvwzLGPpm3dA3rW-pz6PZSlqU",
            authDomain: "tower-defense-785bd.firebaseapp.com",
            projectId: "tower-defense-785bd",
            storageBucket: "tower-defense-785bd.firebasestorage.app",
            messagingSenderId: "129718667702",
            appId: "1:129718667702:web:7cf07310a659679fad5917",
            measurementId: "G-RJK7LVSVEW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tower-defense-v1';

        // --- AUTH ---
        const getFakeEmail = (username) => `${username.trim().toLowerCase().replace(/\s+/g, '')}@towerdefense.game`;
        const authMessage = document.getElementById('authMessage');
        const usernameInput = document.getElementById('usernameInput');
        const passwordInput = document.getElementById('passwordInput');

        const handleLogin = async () => {
            if (!usernameInput.value || !passwordInput.value) { authMessage.innerText = "Fill all fields!"; return; }
            try { authMessage.innerText = "Accessing..."; await signInWithEmailAndPassword(auth, getFakeEmail(usernameInput.value), passwordInput.value); } catch (e) { console.error(e); authMessage.innerText = "Login Failed."; }
        };

        const handleRegister = async () => {
            if (!usernameInput.value || !passwordInput.value) { authMessage.innerText = "Fill all fields!"; return; }
            if (passwordInput.value.length < 6) { authMessage.innerText = "Min 6 chars."; return; }
            try { authMessage.innerText = "Registering..."; const uc = await createUserWithEmailAndPassword(auth, getFakeEmail(usernameInput.value), passwordInput.value); await updateProfile(uc.user, { displayName: usernameInput.value }); authMessage.innerText = "Success! Logging in..."; } catch (e) { console.error(e); authMessage.innerText = "Failed to register."; }
        };

        const handleLogoutInternal = async () => { try { await signOut(auth); } catch (e) { console.error(e); } };
        document.getElementById('btnLogin').addEventListener('click', handleLogin);
        document.getElementById('btnRegister').addEventListener('click', handleRegister);

        // --- GAME DATA ---
        const TILE_SIZE = 40;
        const TOWER_TYPES = {
            archer:  { name: 'Archer',  cost: 50,  range: 120, damage: 20,  cooldown: 40,  color: '#3B82F6', type: 'single', icon: 'fa-bullseye' },
            cannon:  { name: 'Cannon',  cost: 120, range: 100, damage: 60,  cooldown: 90,  color: '#DC2626', type: 'splash', icon: 'fa-bomb' },
            minigun: { name: 'Minigun', cost: 150, range: 80,  damage: 8,   cooldown: 8,   color: '#06B6D4', type: 'single', icon: 'fa-gun' },
            sniper:  { name: 'Sniper',  cost: 200, range: 300, damage: 100, cooldown: 150, color: '#9333EA', type: 'single', shopCost: 5000, icon: 'fa-crosshairs' },
            tesla:   { name: 'Tesla',   cost: 250, range: 110, damage: 45,  cooldown: 50,  color: '#F59E0B', type: 'single', shopCost: 7500, icon: 'fa-bolt' },
            ice:     { name: 'Ice',     cost: 180, range: 90,  damage: 10,  cooldown: 45,  color: '#A5F3FC', type: 'slow',   shopCost: 3000, icon: 'fa-snowflake' },
            flame:   { name: 'Flame',   cost: 220, range: 70,  damage: 2,   cooldown: 3,   color: '#EA580C', type: 'single', shopCost: 4000, icon: 'fa-fire' },
            radar:   { name: 'Radar',   cost: 100, range: 250, damage: 5,   cooldown: 20,  color: '#10B981', type: 'single', shopCost: 2000, icon: 'fa-satellite-dish' },
            laser:   { name: 'Laser',   cost: 300, range: 150, damage: 5,   cooldown: 5,   color: '#EF4444', type: 'single', shopCost: 10000, icon: 'fa-eye' },
            rocket:  { name: 'Rocket',  cost: 400, range: 200, damage: 80,  cooldown: 120, color: '#F97316', type: 'splash', shopCost: 8000, icon: 'fa-rocket' },
            plasma:  { name: 'Plasma',  cost: 500, range: 130, damage: 60,  cooldown: 60,  color: '#8B5CF6', type: 'splash', shopCost: 12000, icon: 'fa-atom' },
            gatling: { name: 'Gatling', cost: 600, range: 100, damage: 15,  cooldown: 4,   color: '#475569', type: 'single', shopCost: 15000, icon: 'fa-person-rifle' },
            mortar:  { name: 'Mortar',  cost: 350, range: 250, damage: 120, cooldown: 200, color: '#78350F', type: 'splash', shopCost: 9000, icon: 'fa-skull' }
        };

        const MAP_DATA = [
            {
                name: "Zig-Zag Valley",
                grid: [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,0,0,0,0,0,1,1,1,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0],[0,1,1,1,1,1,1,0,0,0,1,0,0,0,0,0,0,0,0,0],[0,1,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0],[0,1,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0],[0,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0],[0,1,1,1,1,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,1,1,1],[0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],
                waypoints: [{x:0,y:1},{x:3,y:1},{x:3,y:4},{x:7,y:4},{x:7,y:2},{x:13,y:2},{x:13,y:4},{x:16,y:4},{x:16,y:6},{x:10,y:6},{x:10,y:9},{x:6,y:9},{x:6,y:7},{x:1,y:7},{x:1,y:11},{x:4,y:11},{x:4,y:13},{x:13,y:13},{x:13,y:10},{x:17,y:10},{x:17,y:12},{x:19,y:12}]
            },
            {
                name: "Spiral Labyrinth",
                grid: [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1],[1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1],[1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1],[1,0,1,0,1,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1],[1,0,1,0,1,0,1,1,1,1,1,1,1,1,0,1,0,1,0,1],[1,0,1,0,1,0,1,0,0,0,0,0,0,1,0,1,0,1,0,1],[1,0,1,0,1,0,1,0,1,1,1,1,0,1,0,1,0,1,0,1],[1,0,1,0,1,0,1,0,1,0,0,0,0,1,0,1,0,1,0,1],[1,0,1,0,1,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1],[1,0,1,0,1,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1],[1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1],[1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1],[1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
                waypoints: [{x:0,y:0},{x:19,y:0},{x:19,y:14},{x:2,y:14},{x:2,y:2},{x:17,y:2},{x:17,y:12},{x:4,y:12},{x:4,y:4},{x:15,y:4},{x:15,y:10},{x:6,y:10},{x:6,y:6},{x:13,y:6},{x:13,y:8},{x:8,y:8}]
            },
            {
                name: "Double Trouble",
                grid: [[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,0],[0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
                waypoints: [{x:0,y:0},{x:0,y:2},{x:9,y:2},{x:9,y:5},{x:1,y:5},{x:1,y:8},{x:9,y:8},{x:9,y:11},{x:0,y:11},{x:0,y:14},{x:19,y:14},{x:19,y:11},{x:12,y:11},{x:12,y:8},{x:18,y:8},{x:18,y:5},{x:12,y:5},{x:12,y:2},{x:19,y:2},{x:19,y:0}]
            }
        ];

        // --- GLOBAL VARIABLES ---
        let currentUser = null;
        let shopCoins = 0;
        let userUpgrades = { startMoney: 0 };
        let userUnlockedTowers = ['archer', 'cannon', 'minigun'];
        let userDeck = ['archer', 'cannon', 'minigun'];
        let currentMapGrid = [];
        let currentWaypoints = [];
        let activeScreen = 'login';
        let money = 200;
        let lives = 20;
        let wave = 1;
        let gameActive = false;
        let gameOver = false;
        let totalEnemiesKilled = 0;
        let gameStartTime = 0;
        let enemies = [];
        let towers = [];
        let projectiles = [];
        let particles = [];
        let floatingTexts = [];
        let selectedTowerType = null;
        let selectedTowerInstance = null;
        let enemiesToSpawn = 0;
        let waveInProgress = false;
        let currentMapIndex = 0;

        // --- MANAGERS ---
        class UIManager {
            constructor() {
                this.screens = ['loginScreen', 'homeScreen', 'shopScreen', 'deckScreen', 'mapSelectScreen', 'gameUI'];
                this.navbar = document.getElementById('mainNavbar');
                this.initMapList();
            }
            showScreen(name) {
                this.screens.forEach(id => document.getElementById(id).classList.add('hidden'));
                if (name === 'loginScreen' || name === 'game') this.navbar.classList.add('hidden'); else this.navbar.classList.remove('hidden');
                const target = document.getElementById(name === 'home' ? 'homeScreen' : name === 'shop' ? 'shopScreen' : name === 'deck' ? 'deckScreen' : name === 'mapSelect' ? 'mapSelectScreen' : name === 'game' ? 'gameUI' : name);
                if(target) target.classList.remove('hidden');
                if (name === 'shop') gameSystem.shop.render();
                if (name === 'deck') gameSystem.deck.render();
            }
            initMapList() {
                const container = document.getElementById('mapListContainer');
                container.innerHTML = '';
                MAP_DATA.forEach((map, idx) => {
                    const el = document.createElement('div');
                    el.className = "bg-gray-800 rounded-2xl p-1 border-4 border-gray-700 hover:border-blue-500 transition-all duration-300 cursor-pointer group flex flex-col hover:-translate-y-2 shadow-xl";
                    el.onclick = () => gameSystem.game.start(idx);
                    
                    // GENERATE MINIMAP
                    const miniCanvas = document.createElement('canvas');
                    miniCanvas.width = 300; miniCanvas.height = 200;
                    const mctx = miniCanvas.getContext('2d');
                    const scaleX = 300 / (map.grid[0].length * 40);
                    const scaleY = 200 / (map.grid.length * 40);
                    const scale = Math.min(scaleX, scaleY);
                    
                    mctx.fillStyle = '#064E3B'; // Grass
                    mctx.fillRect(0,0,300,200);
                    
                    for(let r=0; r<map.grid.length; r++){
                        for(let c=0; c<map.grid[0].length; c++){
                             if(map.grid[r][c]===1){
                                 mctx.fillStyle='#374151'; // Path
                                 mctx.fillRect(c*40*scale, r*40*scale, 40*scale, 40*scale);
                             }
                        }
                    }
                    const s = map.waypoints[0], e = map.waypoints[map.waypoints.length-1];
                    mctx.fillStyle='#3B82F6'; mctx.beginPath(); mctx.arc(s.x*scale, s.y*scale, 8, 0, Math.PI*2); mctx.fill();
                    mctx.fillStyle='#EF4444'; mctx.beginPath(); mctx.arc(e.x*scale, e.y*scale, 8, 0, Math.PI*2); mctx.fill();
                    
                    const dataUrl = miniCanvas.toDataURL();

                    el.innerHTML = `<div class="bg-gray-900 h-48 rounded-xl mb-0 relative overflow-hidden m-2 border-2 border-gray-700 group-hover:border-blue-400 transition-colors"><img src="${dataUrl}" class="w-full h-full object-contain" /><div class="absolute inset-0 opacity-10 bg-gradient-to-br from-transparent to-black"></div></div><div class="p-4 pt-2 flex flex-col flex-grow"><h3 class="text-xl font-bold text-white mb-1 group-hover:text-blue-400 transition-colors">${map.name}</h3><div class="mt-auto pt-3 border-t border-gray-700 flex justify-between items-center"><span class="text-xs font-bold text-green-400 bg-green-900/30 px-2 py-1 rounded">NORMAL</span><button class="text-xs bg-blue-600 px-3 py-1 rounded text-white font-bold">SELECT</button></div></div>`;
                    container.appendChild(el);
                });
            }
            updateStats(coins, money, lives, wave) {
                document.getElementById('navCoinDisplay').innerText = coins;
                document.getElementById('moneyDisplay').innerText = `$ ${money}`;
                document.getElementById('livesDisplay').innerText = lives;
                document.getElementById('waveDisplay').innerText = wave;
            }
            closeUpgradeMenu() { document.getElementById('upgradeMenu').classList.add('hidden'); if(gameSystem.game) gameSystem.game.selectedTowerInstance = null; }
        }

        class ShopManager {
            constructor() { this.container = document.getElementById('shopTurretContainer'); this.modal = document.getElementById('shopDetailsModal'); }
            
            // RENDER SHOP ITEMS
            render() {
                this.container.innerHTML = '';
                const items = Object.keys(TOWER_TYPES).filter(k => !['archer','cannon','minigun'].includes(k));
                items.forEach(key => {
                    const t = TOWER_TYPES[key];
                    const unlocked = gameSystem.data.unlockedTowers.includes(key);
                    const el = document.createElement('div');
                    // CLICKABLE CARD BODY TO OPEN DETAILS
                    el.onclick = (e) => { 
                         // Prevent details modal if clicking buy button directly
                         if(e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
                         this.showDetails(key); 
                    };
                    el.className = `bg-gray-800 rounded-xl p-5 border-2 ${unlocked?'border-green-500/50':'border-gray-700'} hover:bg-gray-750 transition relative group cursor-pointer`;
                    
                    el.innerHTML = `
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 rounded-lg border-2 border-white/20 flex items-center justify-center shadow-lg text-white text-lg" style="background-color: ${t.color}"><i class="fa-solid ${t.icon}"></i></div>
                            <div><h3 class="font-bold text-white text-sm font-mono tracking-wide">${t.name.toUpperCase()}</h3><p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">${t.type}</p></div>
                        </div>
                        <div class="space-y-1 text-xs text-gray-400 mb-4 font-mono">
                            <div class="flex justify-between"><span>DAMAGE</span><span class="text-white">${t.damage}</span></div>
                            <div class="flex justify-between"><span>RANGE</span><span class="text-white">${t.range}</span></div>
                        </div>
                        <div class="border-t border-gray-700 pt-3">
                            ${unlocked 
                                ? '<button disabled class="w-full bg-green-900/50 text-green-400 py-2 rounded font-bold text-xs border border-green-500/30">OWNED</button>' 
                                : `<button onclick="window.gameSystem.shop.buyTower('${key}', ${t.shopCost})" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold text-xs shadow-lg active:translate-y-0.5 transition flex items-center justify-center gap-2"><span>BUY</span><span class="bg-black/20 px-1.5 rounded text-[10px] text-yellow-300">${t.shopCost}</span></button>`
                            }
                        </div>
                    `;
                    this.container.appendChild(el);
                });
                document.getElementById('lvl-startMoney').innerText = gameSystem.data.upgrades.startMoney || 0;
                document.getElementById('price-startMoney').innerText = 2000;
            }

            // SHOW DETAILS MODAL
            showDetails(key) {
                const t = TOWER_TYPES[key];
                const unlocked = gameSystem.data.unlockedTowers.includes(key);
                
                // Populate Header
                document.getElementById('modalTitle').innerText = t.name.toUpperCase();
                document.getElementById('modalType').innerText = t.type;
                document.getElementById('modalIcon').innerHTML = `<i class="fa-solid ${t.icon}"></i>`;
                document.getElementById('modalIcon').style.backgroundColor = t.color;

                // Populate Stats & Preview (Next Level logic: Dmg*1.3, Rng*1.1, Rate*0.9)
                // Max values for bars: Dmg 200, Rng 300, Rate (60/CD) max 15
                
                // Damage
                const dmgNext = Math.floor(t.damage * 1.3);
                this.setBar('barDmgBase', 'barDmgUp', 'statDmgCurr', 'statDmgUp', t.damage, dmgNext, 200);

                // Range
                const rngNext = Math.floor(t.range * 1.1);
                this.setBar('barRngBase', 'barRngUp', 'statRngCurr', 'statRngUp', t.range, rngNext, 300);

                // Fire Rate (Speed) - Higher is better
                const rateCurr = (60 / t.cooldown);
                const cdNext = Math.max(5, Math.floor(t.cooldown * 0.9));
                const rateNext = (60 / cdNext);
                this.setBar('barSpdBase', 'barSpdUp', 'statSpdCurr', 'statSpdUp', rateCurr.toFixed(1), rateNext.toFixed(1), 15);

                // Footer Action
                const footer = document.getElementById('modalCostContainer');
                if(unlocked) {
                    footer.innerHTML = '<span class="text-green-400 font-bold text-sm border border-green-500 px-3 py-1 rounded bg-green-900/30">ACQUIRED</span>';
                } else {
                     footer.innerHTML = `<button onclick="window.gameSystem.shop.buyTower('${key}', ${t.shopCost}); window.gameSystem.shop.closeDetails()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded font-bold text-sm shadow-lg active:translate-y-0.5 transition">BUY FOR <span class="text-yellow-300">${t.shopCost}</span></button>`;
                }

                this.modal.classList.remove('hidden');
            }

            closeDetails() {
                this.modal.classList.add('hidden');
            }

            setBar(baseId, upId, txtBaseId, txtUpId, val, nextVal, max) {
                const basePct = Math.min(100, (val / max) * 100);
                const nextPct = Math.min(100, (nextVal / max) * 100);
                const diffPct = nextPct - basePct;
                
                document.getElementById(baseId).style.width = `${basePct}%`;
                document.getElementById(upId).style.width = `${diffPct}%`;
                document.getElementById(txtBaseId).innerText = val;
                document.getElementById(txtUpId).innerText = (Number(nextVal) - Number(val)).toFixed(1).replace(/\.0+$/,''); // cleaner diff
            }

            async buyUpgrade(type, cost) {
                if (gameSystem.data.coins < cost) { alert("Not enough coins!"); return; }
                await gameSystem.data.spendCoins(cost);
                if (type === 'startMoney') gameSystem.data.upgrades.startMoney = (gameSystem.data.upgrades.startMoney||0)+1;
                await gameSystem.data.save(); this.render();
            }
            async buyTower(type, cost) {
                if (gameSystem.data.coins < cost) { alert("Not enough coins!"); return; }
                await gameSystem.data.spendCoins(cost);
                gameSystem.data.unlockedTowers.push(type);
                await gameSystem.data.save(); this.render();
            }
        }

        class DeckManager {
            constructor() {
                this.activeContainer = document.getElementById('activeDeckContainer');
                this.collectionContainer = document.getElementById('collectionContainer');
                this.countDisplay = document.getElementById('deckCount');
            }
            render() {
                this.countDisplay.innerText = gameSystem.data.deck.length;
                this.activeContainer.innerHTML = ''; this.collectionContainer.innerHTML = '';
                if (gameSystem.data.deck.length === 0) this.activeContainer.innerHTML = '<span class="text-gray-500 italic text-xs">Empty deck. Select units below.</span>';
                gameSystem.data.deck.forEach(key => {
                    const t = TOWER_TYPES[key];
                    const el = document.createElement('div');
                    el.className = 'w-16 h-20 bg-gray-800 rounded-lg border border-green-500/50 flex flex-col items-center justify-center cursor-pointer hover:bg-red-900/50 transition relative group p-1';
                    el.onclick = () => this.toggle(key);
                    el.innerHTML = `<div class="w-8 h-8 rounded shadow-md mb-2 border border-white/20 flex items-center justify-center text-white" style="background-color: ${t.color}"><i class="fa-solid ${t.icon}"></i></div><span class="text-[9px] font-bold text-white leading-none text-center">${t.name}</span><div class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-white text-xs opacity-0 group-hover:opacity-100 shadow-lg">&times;</div>`;
                    this.activeContainer.appendChild(el);
                });
                gameSystem.data.unlockedTowers.forEach(key => {
                    const inDeck = gameSystem.data.deck.includes(key);
                    const t = TOWER_TYPES[key];
                    const el = document.createElement('div');
                    el.className = `p-3 rounded-xl border ${inDeck ? 'bg-green-900/20 border-green-600/50 opacity-50 grayscale' : 'bg-gray-800 border-gray-700 hover:border-blue-400 hover:bg-gray-750 cursor-pointer shadow-lg hover:-translate-y-1'} flex flex-col items-center transition-all duration-200`;
                    if (!inDeck) el.onclick = () => this.toggle(key);
                    el.innerHTML = `<div class="w-8 h-8 rounded border border-white/20 mb-2 shadow-inner flex items-center justify-center text-white" style="background-color: ${t.color}"><i class="fa-solid ${t.icon}"></i></div><span class="text-[10px] text-gray-300 font-mono font-bold">${t.name}</span>`;
                    this.collectionContainer.appendChild(el);
                });
            }
            async toggle(key) {
                const deck = gameSystem.data.deck;
                if (deck.includes(key)) gameSystem.data.deck = deck.filter(k => k !== key);
                else { if (deck.length >= 5) { alert("Deck Full (Max 5)!"); return; } gameSystem.data.deck.push(key); }
                this.render(); await gameSystem.data.save();
            }
        }

        class GameEngine {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.isRunning = false;
                this.grid = []; this.waypoints = []; this.enemies = []; this.towers = []; this.projectiles = []; this.particles = []; this.floatingTexts = [];
                this.wave = 1; this.money = 0; this.lives = 0; this.waveInProgress = false; this.enemiesToSpawn = 0; this.spawnTimer = null;
                this.selectedTowerType = null; this.selectedTowerInstance = null; this.startTime = 0; this.kills = 0;
                this.mouseX = 0; this.mouseY = 0;
                this.bindInput();
                document.getElementById('startWaveBtn').addEventListener('click', () => this.startWave());
            }
            start(mapIndex) {
                if (gameSystem.data.deck.length === 0) { alert("Deck is empty! Please select at least 1 tower in the DECK menu."); return; }
                const map = MAP_DATA[mapIndex];
                this.grid = JSON.parse(JSON.stringify(map.grid));
                this.waypoints = map.waypoints.map(p => ({ x: p.x * TILE_SIZE + TILE_SIZE/2, y: p.y * TILE_SIZE + TILE_SIZE/2 }));
                this.money = 200 + ((gameSystem.data.upgrades.startMoney || 0) * 50);
                this.lives = 20; this.wave = 1; this.kills = 0; this.startTime = Date.now();
                this.enemies = []; this.towers = []; this.projectiles = []; this.particles = []; this.floatingTexts = [];
                this.waveInProgress = false; this.selectedTowerType = null; this.selectedTowerInstance = null;
                this.renderTowerButtons();
                gameSystem.ui.showScreen('game');
                gameSystem.ui.closeUpgradeMenu();
                document.getElementById('gameOverScreen').classList.add('hidden');
                this.isRunning = true; this.loop();
            }
            bindInput() {
                this.canvas.addEventListener('mousemove', e => {
                    const rect = this.canvas.getBoundingClientRect();
                    this.mouseX = (e.clientX - rect.left) * (this.canvas.width / rect.width);
                    this.mouseY = (e.clientY - rect.top) * (this.canvas.height / rect.height);
                });
                this.canvas.addEventListener('mousedown', e => this.handleClick());
            }
            handleClick() {
                if (!this.isRunning) return;
                const col = Math.floor(this.mouseX / TILE_SIZE), row = Math.floor(this.mouseY / TILE_SIZE);
                const clicked = this.towers.find(t => t.c === col && t.r === row);
                if (clicked) {
                    this.selectedTowerType = null; this.selectedTowerInstance = clicked;
                    this.updateTowerButtonsUI(); this.showUpgradeMenu(clicked);
                } else if (this.selectedTowerType) {
                    if (this.isValidBuild(col, row)) {
                        const cost = TOWER_TYPES[this.selectedTowerType].cost;
                        if (this.money >= cost) {
                            this.money -= cost; this.towers.push(new Tower(col, row, this.selectedTowerType));
                            for(let i=0; i<10; i++) this.particles.push(new Particle(col*TILE_SIZE+20, row*TILE_SIZE+20, '#FFF'));
                        }
                    }
                } else { gameSystem.ui.closeUpgradeMenu(); }
            }
            isValidBuild(c, r) {
                if (r<0||r>=this.grid.length||c<0||c>=this.grid[0].length) return false;
                if (this.grid[r][c]===1) return false;
                if (this.towers.some(t => t.c===c && t.r===r)) return false;
                return true;
            }
            renderTowerButtons() {
                const container = document.getElementById('gameTowerSelection'); container.innerHTML = '';
                gameSystem.data.deck.forEach(key => {
                    const t = TOWER_TYPES[key];
                    const btn = document.createElement('button');
                    btn.id = `btn-${key}`;
                    btn.onclick = () => { this.selectedTowerType = key; gameSystem.ui.closeUpgradeMenu(); this.updateTowerButtonsUI(); };
                    btn.className = `tower-btn group flex flex-col items-center bg-gray-700 p-2 rounded-xl border-2 border-gray-600 hover:bg-gray-600 hover:border-white w-20 flex-shrink-0 transition-all`;
                    btn.innerHTML = `<div class="w-8 h-8 rounded-lg border border-white/30 mb-1 shadow-lg flex items-center justify-center text-white" style="background-color: ${t.color}"><i class="fa-solid ${t.icon}"></i></div><span class="text-[10px] font-bold text-white">${t.name}</span><span class="text-[10px] font-mono text-yellow-400">$${t.cost}</span>`;
                    container.appendChild(btn);
                });
            }
            updateTowerButtonsUI() {
                const btns = document.querySelectorAll('#gameTowerSelection button');
                btns.forEach(b => { b.classList.remove('border-yellow-400', 'ring-2', 'ring-yellow-400/50'); b.classList.add('border-gray-600'); });
                if (this.selectedTowerType) {
                    const active = document.getElementById(`btn-${this.selectedTowerType}`);
                    if (active) { active.classList.remove('border-gray-600'); active.classList.add('border-yellow-400', 'ring-2', 'ring-yellow-400/50'); }
                }
            }
            startWave() {
                if (this.waveInProgress) return;
                this.waveInProgress = true;
                const btn = document.getElementById('startWaveBtn');
                btn.innerText = "WAVE RUNNING..."; btn.disabled = true; btn.classList.remove('animate-pulse'); btn.classList.add('opacity-50', 'cursor-not-allowed');
                let count = 5 + Math.floor(this.wave * 1.5);
                let hp = 40 + (this.wave * 25);
                let speed = Math.min(5, 2 + (this.wave * 0.1));
                let reward = 10 + Math.floor(this.wave / 2);
                this.enemiesToSpawn = count;
                this.spawnTimer = setInterval(() => {
                    if (!this.isRunning) { clearInterval(this.spawnTimer); return; }
                    if (this.enemiesToSpawn > 0) { this.enemies.push(new Enemy(hp, speed, reward, this.waypoints)); this.enemiesToSpawn--; }
                    else { clearInterval(this.spawnTimer); }
                }, 800);
            }
            surrender() { if(this.isRunning) this.endGame('surrender'); }
            endGame(reason) {
                this.isRunning = false; clearInterval(this.spawnTimer);
                const coinsEarned = (Math.max(0, this.wave - 1) * 100) + (this.kills * 10); // INCREASED REWARD
                gameSystem.data.addCoins(coinsEarned);
                const t = document.getElementById('gameOverTitle'), s = document.getElementById('gameOverSubtitle');
                if (reason === 'surrender') { t.innerText = "MISSION ABORTED"; t.className = "text-4xl md:text-6xl font-bold text-yellow-400 mb-2 pixel-font text-center leading-tight tracking-wider drop-shadow-lg"; s.innerText = "Troops Withdrawn"; }
                else { t.innerText = "GAME OVER"; t.className = "text-4xl md:text-6xl font-bold text-red-600 mb-2 pixel-font text-center leading-tight tracking-wider drop-shadow-lg"; s.innerText = "Base Destroyed!"; }
                document.getElementById('statWave').innerText = this.wave; document.getElementById('statKilled').innerText = this.kills; document.getElementById('statCoinsEarned').innerText = "+" + coinsEarned; document.getElementById('statTotalCoins').innerText = gameSystem.data.coins + coinsEarned;
                document.getElementById('gameOverScreen').classList.remove('hidden');
            }
            quit() { this.isRunning = false; gameSystem.ui.showScreen('home'); }
            restart() { this.start(currentMapIndex); }
            showUpgradeMenu(tower) {
                const menu = document.getElementById('upgradeMenu'); menu.classList.remove('hidden');
                document.getElementById('upgName').innerText = tower.stats.name; document.getElementById('upgLevel').innerText = tower.level;
                document.getElementById('upgDamage').innerText = tower.stats.damage; document.getElementById('upgRange').innerText = tower.stats.range; document.getElementById('upgSpeed').innerText = Math.round(6000/tower.stats.cooldown)/100 + '/s';
                document.getElementById('upgCost').innerText = `$ ${tower.upgradeCost}`; document.getElementById('sellValue').innerText = `$ ${Math.floor(tower.stats.cost * 0.5)}`;
                const btn = document.getElementById('btnUpgradeAction');
                if (this.money >= tower.upgradeCost) { btn.classList.remove('opacity-50', 'cursor-not-allowed'); btn.disabled = false; }
                else { btn.classList.add('opacity-50', 'cursor-not-allowed'); btn.disabled = true; }
            }
            upgradeSelected() {
                if(!this.selectedTowerInstance) return;
                const cost = this.selectedTowerInstance.upgradeCost;
                if (this.money >= cost) {
                    this.money -= cost;
                    this.selectedTowerInstance.upgrade(this.particles);
                    this.showUpgradeMenu(this.selectedTowerInstance);
                }
            }
            sellSelected() {
                if(!this.selectedTowerInstance) return;
                this.money += Math.floor(this.selectedTowerInstance.stats.cost * 0.5);
                this.towers = this.towers.filter(t => t !== this.selectedTowerInstance);
                this.selectedTowerInstance = null;
                gameSystem.ui.closeUpgradeMenu();
            }
            loop() {
                if (!this.isRunning) return;
                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    let e = this.enemies[i];
                    if (e.update()) { this.lives--; this.enemies.splice(i, 1); }
                    else if (e.hp <= 0) {
                        this.money += e.reward; this.kills++;
                        for(let j=0;j<5;j++) this.particles.push(new Particle(e.x, e.y, '#4ADE80'));
                        this.floatingTexts.push(new FloatingText(e.x, e.y, `+$${e.reward}`, '#FACC15'));
                        this.enemies.splice(i, 1);
                    }
                }
                if (this.waveInProgress && this.enemiesToSpawn === 0 && this.enemies.length === 0) {
                    this.waveInProgress = false; this.wave++;
                    const btn = document.getElementById('startWaveBtn');
                    btn.innerText = "START WAVE " + this.wave; btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); btn.classList.add('animate-pulse');
                    this.floatingTexts.push(new FloatingText(this.canvas.width/2, this.canvas.height/2, "WAVE COMPLETE!", '#FFF', 120));
                }
                this.towers.forEach(t => t.update(this.enemies, this.projectiles, this.particles));
                for (let i = this.projectiles.length - 1; i >= 0; i--) {
                    if (this.projectiles[i].active === false) { this.projectiles.splice(i, 1); continue; }
                    this.projectiles[i].update(this.enemies, this.particles);
                }
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    this.particles[i].update(); if (this.particles[i].life <= 0) this.particles.splice(i, 1);
                }
                for (let i = this.floatingTexts.length - 1; i >= 0; i--) {
                    this.floatingTexts[i].update(); if (this.floatingTexts[i].life <= 0) this.floatingTexts.splice(i, 1);
                }
                if (this.lives <= 0) { this.endGame('defeat'); return; }
                gameSystem.ui.updateStats(gameSystem.data.coins, this.money, this.lives, this.wave);
                this.draw();
                requestAnimationFrame(() => this.loop());
            }
            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                for (let r = 0; r < this.grid.length; r++) {
                    for (let c = 0; c < this.grid[0].length; c++) {
                        let x = c * TILE_SIZE, y = r * TILE_SIZE;
                        if (this.grid[r][c] === 1) {
                            this.ctx.fillStyle = '#374151'; this.ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                            this.ctx.strokeStyle = '#4B5563'; this.ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE);
                        } else {
                            this.ctx.fillStyle = ((c + r) % 2 === 0) ? '#064E3B' : '#065F46';
                            this.ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                        }
                    }
                }
                if (this.waypoints.length > 0) {
                    let s = this.waypoints[0], e = this.waypoints[this.waypoints.length - 1];
                    this.ctx.save(); this.ctx.translate(s.x, s.y); this.ctx.fillStyle = '#3B82F6'; this.ctx.fillRect(-15, -15, 30, 30);
                    this.ctx.fillStyle = 'white'; this.ctx.font = 'bold 10px sans-serif'; this.ctx.textAlign = 'center'; this.ctx.fillText("IN", 0, 4); this.ctx.restore();
                    this.ctx.save(); this.ctx.translate(e.x, e.y); this.ctx.fillStyle = '#EF4444'; 
                    this.ctx.beginPath(); this.ctx.moveTo(0,-15); this.ctx.lineTo(15,0); this.ctx.lineTo(0,15); this.ctx.lineTo(-15,0); this.ctx.fill();
                    this.ctx.fillStyle = 'white'; this.ctx.fillText("HQ", 0, 4); this.ctx.restore();
                    if (!this.waveInProgress && this.enemies.length === 0) {
                        const off = Math.sin(Date.now() / 200) * 5;
                        this.ctx.save(); this.ctx.translate(s.x, s.y - 35 + off); this.ctx.fillStyle = '#FACC15';
                        this.ctx.beginPath(); this.ctx.moveTo(-8,-8); this.ctx.lineTo(8,-8); this.ctx.lineTo(0,8); this.ctx.fill();
                        this.ctx.font = 'bold 10px sans-serif'; this.ctx.textAlign = 'center'; this.ctx.shadowColor='black'; this.ctx.shadowBlur=2;
                        this.ctx.fillText("SPAWN", 0, -12); this.ctx.restore();
                    }
                }
                let mx = Math.floor(this.mouseX / TILE_SIZE) * TILE_SIZE, my = Math.floor(this.mouseY / TILE_SIZE) * TILE_SIZE;
                if (this.selectedTowerType && mx >= 0 && mx < this.canvas.width && my >= 0 && my < this.canvas.height) {
                    let col = Math.floor(this.mouseX / TILE_SIZE), row = Math.floor(this.mouseY / TILE_SIZE);
                    let valid = this.isValidBuild(col, row);
                    this.ctx.lineWidth = 2; this.ctx.strokeStyle = valid ? 'white' : 'red'; this.ctx.strokeRect(mx, my, TILE_SIZE, TILE_SIZE);
                    this.ctx.beginPath(); this.ctx.arc(mx + TILE_SIZE/2, my + TILE_SIZE/2, TOWER_TYPES[this.selectedTowerType].range, 0, Math.PI * 2);
                    this.ctx.fillStyle = valid ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 0, 0, 0.2)'; this.ctx.fill(); this.ctx.stroke();
                }
                if (this.selectedTowerInstance) {
                    const t = this.selectedTowerInstance;
                    this.ctx.beginPath(); this.ctx.arc(t.x, t.y, t.stats.range, 0, Math.PI * 2);
                    this.ctx.fillStyle = 'rgba(255, 255, 255, 0.1)'; this.ctx.fill();
                    this.ctx.strokeStyle = '#FACC15'; this.ctx.lineWidth = 2; this.ctx.stroke();
                    this.ctx.strokeRect(t.c * TILE_SIZE, t.r * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
                this.enemies.forEach(e => e.draw(this.ctx));
                this.towers.forEach(t => t.draw(this.ctx));
                this.projectiles.forEach(p => p.draw(this.ctx));
                this.particles.forEach(p => p.draw(this.ctx));
                this.floatingTexts.forEach(ft => ft.draw(this.ctx));
            }
        }

        class DataManager {
            constructor() {
                this.coins = 0;
                this.upgrades = { startMoney: 0 };
                this.unlockedTowers = ['archer', 'cannon', 'minigun'];
                this.deck = ['archer', 'cannon', 'minigun'];
            }
            async load(user) {
                try {
                    const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'game_data', 'stats');
                    const snap = await getDoc(ref);
                    if (snap.exists()) {
                        const d = snap.data();
                        this.coins = d.coins || 0;
                        if (d.upgrades) this.upgrades = { ...this.upgrades, ...d.upgrades };
                        if (d.unlockedTowers) this.unlockedTowers = d.unlockedTowers;
                        if (d.deck) this.deck = d.deck;
                    } else {
                        await setDoc(ref, { coins: 0, upgrades: this.upgrades, unlockedTowers: this.unlockedTowers, deck: this.deck });
                    }
                    gameSystem.ui.updateStats(this.coins, 0, 0, 0);
                } catch (e) { console.error("Load Error", e); }
            }
            async save() {
                if (!auth.currentUser) return;
                try {
                    const ref = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'game_data', 'stats');
                    await updateDoc(ref, { coins: this.coins, deck: this.deck, unlockedTowers: this.unlockedTowers, upgrades: this.upgrades });
                    gameSystem.ui.updateStats(this.coins, 0, 0, 0);
                } catch (e) { console.error("Save Error", e); }
            }
            async addCoins(amount) {
                this.coins += amount;
                if (!auth.currentUser) return;
                const ref = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'game_data', 'stats');
                await updateDoc(ref, { coins: increment(amount) });
                gameSystem.ui.updateStats(this.coins, 0, 0, 0);
            }
            async spendCoins(amount) {
                this.coins -= amount;
                if (!auth.currentUser) return;
                const ref = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'game_data', 'stats');
                await updateDoc(ref, { coins: increment(-amount) });
                gameSystem.ui.updateStats(this.coins, 0, 0, 0);
            }
        }

        class GameSystem {
            constructor() {
                this.data = new DataManager();
                this.ui = new UIManager();
                this.shop = new ShopManager();
                this.deck = new DeckManager();
                this.game = new GameEngine();
                this.auth = { login: handleLogin, register: handleRegister, logout: handleLogoutInternal };
            }
        }

        window.gameSystem = new GameSystem();
        
        onAuthStateChanged(auth, async (user) => {
            const loginScreen = document.getElementById('loginScreen');
            if (user) {
                let displayName = user.displayName || user.email.split('@')[0];
                document.getElementById('navUsername').innerText = displayName;
                await window.gameSystem.data.load(user);
                loginScreen.classList.add('hidden');
                window.gameSystem.ui.showScreen('home');
            } else {
                loginScreen.classList.remove('hidden');
                window.gameSystem.ui.showScreen('loginScreen');
            }
        });
    </script>
</body>
</html>